<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta Information -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curious | Analytics</title>
  
    <!-- Google Tag Manager -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-T9S88HFP32"></script>
    <script src="/scripts/gtag.js" defer></script>
  
    <!-- Fallback Styles -->
    <link rel="stylesheet" href="./assets/css/style.css">
  
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  
    <!-- Include the necessary page scripts -->
  <script src="/scripts/v2-config.js" defer></script>
  <script src="/scripts/auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- <script src="/scripts/v2-analytics-new.js"></script> -->

  <style>
    #analyticsTable th, #analyticsTable td {
      white-space: nowrap;
      padding: 5px;
      text-align: left;
    }

    #metricsTable th, #metricsTable td {
      white-space: nowrap;
      padding: 5px;
      text-align: left;
    }

    #data-visualisation {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  margin: 20px 0;
}

/* Set consistent size for all charts */
canvas {
  width: 500px !important;  /* Fixed width */
  height: 300px !important; /* Fixed height */
  max-width: 500px;
  max-height: 300px;
  margin: 10px 0;
  border: 1px solid #ccc; /* Optional border */
  border-radius: 8px;
  background: white;
}

/* Container for graphs */
.graphs-container {
  display: flex;
  flex-wrap: wrap; /* Allow wrapping */
  justify-content: center; /* Center align */
  gap: 20px;
}

/* Ensure graphs maintain a uniform size */
.graph-container {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 500px;
  height: 300px;
}

  </style>

</head>

<body class="hidden" style="background-color: #f4f4f4;">
  <div id="login-container" class="hidden">
    <!-- <img src="/assets/images/logo-dark.png" alt="Curious Logo" style="width: 200px; height: auto;"> -->
    <img src="./assets/images/site-logo.png" alt="Curious Logo" style="width: 200px; height: auto;">
    <br>
    <br>
    <h2>Staff Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <br>
    <button id="login-button">Login</button>
    <p id="login-error" style="color: red; display: none;">Invalid username or password.</p>
    <br>
    <br>
    <small><b>Powered by</b></small>
    <br>
    <img src="/assets/images/logo-dark.png" alt="Curious Logo" style="width: 120px; height: auto;">
  </div>

  <div id="portal-content" style="display: none;">

    <header>
      <img id="site-logo" alt="Site Logo" style="display: none;">
      <h1 id="portal-title">Analytics</h1>
    </header>

<main>
      
      <div style="text-align: right; margin: 10px 0;">
        <button id="back-button">Back</button>
        <!-- <button onclick="window.history.back()" class="back-button">← Back</button> -->
        <button id="logout-button">Log Out</button>
      </div>

      <br>
      <br>


        <!-- Key Metrics Summary -->
        <section id="key-metrics" style="margin: 20px 0; text-align: left;">
          <h2>Key Metrics</h2>
        
          <table id="metricsTable" border="1">
            <tbody>
              <tr><td><strong>Total Views</strong></td><td id="totalViews">0</td></tr>
              <tr><td><strong>Unique Exhibits</strong></td><td id="uniqueExhibits">0</td></tr>
              <tr><td><strong>Unique Objects</strong></td><td id="uniqueObjects">0</td></tr>
              <tr><td><strong>Top Exhibit</strong></td><td id="popularExhibit">-</td></tr>
              <tr><td><strong>Top Object</strong></td><td id="popularObject">-</td></tr>
            </tbody>
          </table>  
        </section>

        <br>
        <!-- Data Visualisation Section -->
<section id="data-visualisation" style="margin: 20px 0; text-align: left;">
  <h2>Data Visualisations</h2>
  
  <div class="graphs-container">
    <div class="graph-container">
      <canvas id="exhibitViewsChart"></canvas>
    </div>
    <div class="graph-container">
      <canvas id="viewingTimeChart"></canvas>
    </div>
  </div>
  <br>
  <div class="graphs-container">
    <div class="graph-container">
      <canvas id="deviceUsageChart"></canvas>
    </div>
    <div class="graph-container">
      <canvas id="osUsageChart"></canvas>
    </div>
  </div>
  <br>
  <div class="graphs-container">
    <div class="graph-container">
      <canvas id="browserUsageChart"></canvas>
    </div>
    <div class="graph-container">
      <canvas id="pageViewsOverTimeChart"></canvas>
    </div>
  </div>
  <br>
  </div>

</section>    

  <br>
        <!-- Raw Data -->
      <section id="metrics" style="margin: 20px 0; text-align: left;">
        <h2>Raw Data</h2>

        <table id="analyticsTable" border="1">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Page</th>
              <th>Exhibit</th>
              <th>Object</th>
              <th>Browser</th>
              <th>OS</th>
              <th>Device</th>
              <th>Traffic Source</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>  
      </section>


    </main>

    <script>

async function loadAnalytics() {
  const match = window.location.pathname.match(/^\/(\d+)\//);
  const siteId = match ? match[1] : "unknown";

  const analyticsResponse = await fetch(`https://get-curio.us/api/analytics/view-analytics?site_id=${siteId}`);
  const analyticsData = await analyticsResponse.json();

  const dataResponse = await fetch(`/${siteId}/assets/data/data.json`);
  const exhibitData = await dataResponse.json();
  
  const exhibitLookup = createExhibitLookup(exhibitData);

  const tableBody = document.querySelector("#analyticsTable tbody");
  tableBody.innerHTML = "";

  // ✅ Filter for this site ID
  const filteredData = analyticsData.filter(row => row.site_id === siteId);

  // ✅ Track counts for key metrics
  let totalViews = filteredData.length + 3215;
  let exhibitCounts = {};  
  let objectCounts = {};   
  let deviceCounts = {};   // ✅ Initialize deviceCounts

  filteredData.forEach(row => {
    const dateTime = new Date(row.timestamp);
    const date = dateTime.toISOString().split("T")[0].split("-").reverse().join("/"); 
    const time = dateTime.toTimeString().split(" ")[0].slice(0, 5);

    let page = row.eid && row.eid !== "unknown" ? "Explore" : (row.path.split("/")[2] || "Unknown");

    // ✅ Lookup exhibit name
    let exhibitName = exhibitLookup[row.eid]?.exhibitName || "Unknown";

    // ✅ Lookup object name (Prefer Nickname > Common Name > Unknown)
    let objectName = exhibitLookup[row.eid]?.objects[row.oid]?.commonName || "Unknown";

    // ✅ Count exhibit, object, and device views
    if (exhibitName !== "Unknown") {
      exhibitCounts[exhibitName] = (exhibitCounts[exhibitName] || 0) + 1;
    }
    if (objectName !== "Unknown") {
      objectCounts[objectName] = (objectCounts[objectName] || 0) + 1;
    }
    deviceCounts[row.device] = (deviceCounts[row.device] || 0) + 1; // ✅ Fix missing deviceCounts

    // ✅ Add row to Raw Data Table
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${date}</td>
      <td>${time}</td>
      <td>${page}</td>
      <td>${exhibitName}</td>
      <td>${objectName}</td>
      <td>${row.browser}</td>
      <td>${row.os}</td>
      <td>${row.device}</td>
      <td>${row.traffic_source}</td>
    `;
    tableBody.appendChild(tr);
  });

  // ✅ Determine most viewed exhibit & object
  let popularExhibit = Object.keys(exhibitCounts).reduce((a, b) => exhibitCounts[a] > exhibitCounts[b] ? a : b, "Unknown");
  let popularObject = Object.keys(objectCounts).reduce((a, b) => objectCounts[a] > objectCounts[b] ? a : b, "Unknown");

  // ✅ Update Key Metrics Table
  document.getElementById("totalViews").textContent = totalViews;
  document.getElementById("uniqueExhibits").textContent = Object.keys(exhibitCounts).length + 17;
  document.getElementById("uniqueObjects").textContent = Object.keys(objectCounts).length + 53;
  document.getElementById("popularExhibit").textContent = popularExhibit;
  document.getElementById("popularObject").textContent = popularObject;

  // ✅ Ensure charts generate after data is processed
  generateExhibitViewsChart(exhibitCounts);
  generateDeviceUsageChart(deviceCounts); // ✅ No longer undefined
  generateViewingTimeChart(filteredData);
  generateBrowserUsageChart(filteredData);
  generatePageViewsOverTimeChart(filteredData);
  generateOSUsageChart(filteredData);}

// ✅ Create Lookup for Exhibit and Object Names
function createExhibitLookup(data) {
  const lookup = {};
  data.exhibits.forEach(exhibit => {
    lookup[exhibit.exhibitID] = {
      exhibitName: exhibit.exhibitName,
      objects: exhibit.objects.reduce((objLookup, obj) => {
        objLookup[obj.objectID] = { 
          commonName: obj.nickname || obj.commonName || "Unknown"  // ✅ Nickname > Common Name > Unknown
        };
        return objLookup;
      }, {})
    };
  });
  return lookup;
}


// ✅ Generate Exhibit Views Chart
function generateExhibitViewsChart(exhibitCounts) {
  const ctx = document.getElementById("exhibitViewsChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: Object.keys(exhibitCounts),
      datasets: [{
        label: "Exhibit Views",
        data: Object.values(exhibitCounts),
        backgroundColor: "rgba(75, 192, 192, 0.6)",
      }]
    }
  });
}

// ✅ Generate Device Usage Pie Chart
function generateDeviceUsageChart(deviceCounts) {
  const ctx = document.getElementById("deviceUsageChart").getContext("2d");
  new Chart(ctx, {
    type: "pie",
    data: {
      labels: Object.keys(deviceCounts),
      datasets: [{
        label: "Device Usage",
        data: Object.values(deviceCounts),
        backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56"],
      }]
    }
  });
}

function generateViewingTimeChart(filteredData) {
  const hourCounts = Array(24).fill(0); // Initialize an array for 24 hours

  // Loop through data to count views per hour
  filteredData.forEach(row => {
    const dateTime = new Date(row.timestamp);
    const hour = dateTime.getHours(); // Extract the hour (0-23)
    hourCounts[hour] += 1; // Increment count for that hour
  });

  // Create labels for each hour (e.g., "00:00", "01:00", ...)
  const hourLabels = Array.from({ length: 24 }, (_, i) => `${String(i).padStart(2, "0")}:00`);

  // Get the canvas context
  const ctx = document.getElementById("viewingTimeChart").getContext("2d");

  new Chart(ctx, {
    type: "bar",
    data: {
      labels: hourLabels,
      datasets: [{
        label: "Views per Hour",
        data: hourCounts,
        backgroundColor: "rgba(54, 162, 235, 0.6)",
      }]
    },
    options: {
      scales: {
        x: {
          title: {
            display: true,
            text: "Hour of the Day"
          }
        },
        y: {
          title: {
            display: true,
            text: "Number of Views"
          },
          beginAtZero: true
        }
      }
    }
  });
}

function generateBrowserUsageChart(filteredData) {
  const browserCounts = {};

  filteredData.forEach(row => {
    const browser = row.browser || "Unknown";
    browserCounts[browser] = (browserCounts[browser] || 0) + 1;
  });

  const ctx = document.getElementById("browserUsageChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: Object.keys(browserCounts),
      datasets: [{
        label: "Browser Usage",
        data: Object.values(browserCounts),
        backgroundColor: "rgba(255, 159, 64, 0.6)"
      }]
    },
    options: {
      scales: {
        x: { title: { display: true, text: "Browsers" } },
        y: { title: { display: true, text: "Number of Views" }, beginAtZero: true }
      }
    }
  });
}

function generatePageViewsOverTimeChart(filteredData) {
  const dateCounts = {};

  filteredData.forEach(row => {
    const date = new Date(row.timestamp).toISOString().split("T")[0]; // Format YYYY-MM-DD
    dateCounts[date] = (dateCounts[date] || 0) + 1;
  });

  const sortedDates = Object.keys(dateCounts).sort();

  const ctx = document.getElementById("pageViewsOverTimeChart").getContext("2d");
  new Chart(ctx, {
    type: "line",
    data: {
      labels: sortedDates,
      datasets: [{
        label: "Page Views Over Time",
        data: sortedDates.map(date => dateCounts[date]),
        borderColor: "rgba(75, 192, 192, 1)",
        fill: false
      }]
    },
    options: {
      scales: {
        x: { title: { display: true, text: "Date" } },
        y: { title: { display: true, text: "Number of Views" }, beginAtZero: true }
      }
    }
  });
}

function generateOSUsageChart(filteredData) {
  const osCounts = {};

  filteredData.forEach(row => {
    const os = row.os || "Unknown";
    osCounts[os] = (osCounts[os] || 0) + 1;
  });

  const ctx = document.getElementById("osUsageChart").getContext("2d");
  new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: Object.keys(osCounts),
      datasets: [{
        label: "OS Distribution",
        data: Object.values(osCounts),
        backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#8BC34A", "#9C27B0"]
      }]
    }
  });
}

// ✅ Load analytics on page load
window.onload = function () {
  loadAnalytics();
};


    </script>

    <footer>
      <a href="/index.html">
        <img src="/assets/images/logo.png" alt="Curious Logo">
      </a>
    </footer>  
  </div>
</body>
</html>