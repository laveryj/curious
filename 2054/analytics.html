<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curious | Analytics</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-T9S88HFP32"></script>
    <script src="/scripts/gtag.js" defer></script>
  
    <link rel="stylesheet" href="./assets/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  
    <script src="/scripts/v2-config.js" defer></script>
    <script src="/scripts/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        #analyticsTable th, #analyticsTable td, #metricsTable th, #metricsTable td {
            white-space: nowrap;
            padding: 5px;
            text-align: left;
        }

        #data-visualisation {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin: 20px 0;
        }

        canvas {
            width: 500px !important;
            height: 300px !important;
            max-width: 500px;
            max-height: 300px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: white;
        }

        .graphs-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .graph-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 500px;
            height: 300px;
        }

        .dropdown-container {
            text-align: center;
            margin: 20px 0;
        }

        select {
            padding: 8px;
            font-size: 16px;
        }
    </style>
</head>
<body class="hidden" style="background-color: #f4f4f4;">
    <div id="portal-content">
        <header>
            <h1 id="portal-title">Analytics</h1>
        </header>

        <main>
            <div style="text-align: right; margin: 10px 0;">
                <button id="logout-button">Log Out</button>
            </div>

            <section>
                <h2>Key Metrics Summary</h2>
                <table id="metricsTable" border="1">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Today</th>
                            <th>Yesterday</th>
                            <th>Last 7 Days</th>
                            <th>Last 30 Days</th>
                            <th>All Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td><strong>Page Views</strong></td><td id="totalViews-today">0</td><td id="totalViews-yesterday">0</td><td id="totalViews-last7days">0</td><td id="totalViews-last30days">0</td><td id="totalViews-alltime">0</td></tr>
                        <tr><td><strong>Unique Exhibits</strong></td><td id="uniqueExhibits-today">0</td><td id="uniqueExhibits-yesterday">0</td><td id="uniqueExhibits-last7days">0</td><td id="uniqueExhibits-last30days">0</td><td id="uniqueExhibits-alltime">0</td></tr>
                        <tr><td><strong>Unique Objects</strong></td><td id="uniqueObjects-today">0</td><td id="uniqueObjects-yesterday">0</td><td id="uniqueObjects-last7days">0</td><td id="uniqueObjects-last30days">0</td><td id="uniqueObjects-alltime">0</td></tr>
                        <tr><td><strong>Top Exhibit</strong></td><td id="popularExhibit-today">-</td><td id="popularExhibit-yesterday">-</td><td id="popularExhibit-last7days">-</td><td id="popularExhibit-last30days">-</td><td id="popularExhibit-alltime">-</td></tr>
                        <tr><td><strong>Top Object</strong></td><td id="popularObject-today">-</td><td id="popularObject-yesterday">-</td><td id="popularObject-last7days">-</td><td id="popularObject-last30days">-</td><td id="popularObject-alltime">-</td></tr>
                    </tbody>
                </table>
            </section>

            <br>
            <br>

            <section>
                <h2>Data Visualisations</h2>
                <div class="dropdown-container">
                    <label for="period-select"><strong>Show Visualisations For:</strong></label>
                    <select id="period-select">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="last7days">Last 7 Days</option>
                        <option value="last30days">Last 30 Days</option>
                        <option value="alltime">All Time</option>
                    </select>
                    <p>NB. Visualisations are only active for page views since the feature went live. Older page views will not be graphed.</p>
                </div>

                <div class="graphs-container">
                    <div class="graph-container"><canvas id="exhibitViewsChart"></canvas></div>
                    <div class="graph-container"><canvas id="viewingTimeChart"></canvas></div>
                </div>
                <br>
                <div class="graphs-container">
                    <div class="graph-container"><canvas id="deviceUsageChart"></canvas></div>
                    <div class="graph-container"><canvas id="osUsageChart"></canvas></div>
                </div>
            </section>

            <br>
            <br>

            <section>
              <h2>Raw Data</h2>
              <table id="rawDataTable" border="1">
                  <thead>
                      <tr>
                          <th>Date</th>
                          <th>Time</th>
                          <!-- <th>Page</th> -->
                          <th>Exhibit</th>
                          <th>Object</th>
                          <th>Browser</th>
                          <th>OS</th>
                          <th>Device</th>
                          <!-- <th>Traffic Source</th> -->
                      </tr>
                  </thead>
                  <tbody></tbody>
              </table>
              <br>
              <div id="pagination">
                  <button id="prevPage">Previous</button>
                  <span id="pageInfo"></span>
                  <button id="nextPage">Next</button>
              </div>
              <br>
              <button id="downloadCSV">Download Analytics Data</button>
          </section>
        </main>

        <script>
document.addEventListener("DOMContentLoaded", function () {
    const loginContainer = document.getElementById("login-container");
    if (loginContainer) {
        loginContainer.style.display = "none";
    }
});

const chartInstances = {};
let rawData = [];
let currentPage = 1;
const rowsPerPage = 10;

let exhibitLookup = {};

async function loadExhibitData(siteId) {
    try {
        const response = await fetch(`/${siteId}/assets/data/data.json`);
        const exhibitData = await response.json();

        exhibitLookup = createExhibitLookup(exhibitData);
        console.log("üìÑ Exhibit Lookup Table Created:", exhibitLookup);
    } catch (error) {
        console.error("‚ùå Failed to fetch exhibit names:", error);
    }
}

async function loadAnalytics() {
    const match = window.location.pathname.match(/^\/(\d+)\//);
    if (!match) return console.error("‚ùå No valid site ID found.");

    const siteId = match[1];
    const periods = ["today", "yesterday", "last7days", "last30days", "alltime"];
    console.log(`üì° Fetching analytics for site ${siteId}`);

    await loadExhibitData(siteId); // ‚úÖ Load exhibit lookup first

    for (const period of periods) {
        try {
            const response = await fetch(`https://get-curio.us/api/view-analytics/${siteId}/${period}/`);
            const data = await response.json();
            if (!data || data.error) continue;

            // ‚úÖ Replace EID and OID with actual names using the lookup
            const topExhibit = exhibitLookup[data.top_exhibit]?.exhibitName ?? data.top_exhibit ?? "No data";
            const topObject = getObjectName(data.top_object); // ‚úÖ New lookup function
            
            // ‚úÖ Update the table dynamically for each period
            // document.getElementById(`totalViews-${period}`).textContent = data.total_views ?? 0;
            document.getElementById(`totalViews-${period}`).textContent = period === "alltime" ? (data.total_views + 4164) : data.total_views ?? 0;
            document.getElementById(`uniqueExhibits-${period}`).textContent = data.unique_exhibits ?? 0;
            document.getElementById(`uniqueObjects-${period}`).textContent = data.unique_objects ?? 0;
            document.getElementById(`popularExhibit-${period}`).textContent = topExhibit;
            document.getElementById(`popularObject-${period}`).textContent = topObject;

        } catch (error) {
            console.error(`‚ùå Fetch Error for ${period}:`, error);
        }
    }
}

function updateVisualisations(period) {
    const match = window.location.pathname.match(/^\/(\d+)\//);
    if (!match) return;

    const siteId = match[1];
    fetch(`https://get-curio.us/api/view-analytics/${siteId}/${period}/`)
        .then(response => response.json())
        .then(data => {
            destroyChart("exhibitViewsChart");
            destroyChart("viewingTimeChart");
            destroyChart("deviceUsageChart");
            destroyChart("osUsageChart");

            // ‚úÖ Convert Exhibit IDs to Names for Exhibit Views
            let exhibitViews = {};
            for (let eid in data.exhibit_views) {
                exhibitViews[exhibitLookup[eid]?.exhibitName || eid] = data.exhibit_views[eid];
            }

            // ‚úÖ Sort exhibits by number of views (largest to smallest)
            const sortedExhibits = Object.entries(exhibitViews)
                .sort((a, b) => b[1] - a[1]); // Sort by count (descending)

            const sortedLabels = sortedExhibits.map(entry => entry[0]); // Sorted exhibit names
            const sortedValues = sortedExhibits.map(entry => entry[1]); // Sorted view counts

            // ‚úÖ Update all charts properly
            updateChart("exhibitViewsChart", "bar", sortedLabels, sortedValues, "Exhibit Views");
            updateChart("viewingTimeChart", "line", Object.keys(data.viewing_time_distribution), Object.values(data.viewing_time_distribution), "Viewing Time");
            updateChart("deviceUsageChart", "pie", Object.keys(data.device_usage), Object.values(data.device_usage), "Device Usage");
            updateChart("osUsageChart", "doughnut", Object.keys(data.os_usage), Object.values(data.os_usage), "OS Distribution");
        })
        .catch(error => console.error("‚ùå Failed to fetch analytics:", error));
}

// ‚úÖ Ensure updateChart accepts labels & values
function updateChart(elementId, type, labels, values, label) {
    if (!labels || !values || labels.length === 0 || values.length === 0) {
        console.warn(`‚ö†Ô∏è No data for ${elementId}, skipping update.`);
        return;
    }

    const ctx = document.getElementById(elementId).getContext("2d");

    // Calculate total value for percentage calculation
    const total = values.reduce((sum, value) => sum + value, 0);

    chartInstances[elementId] = new Chart(ctx, { 
        type, 
        data: { 
            labels: labels, 
            datasets: [{ 
                label, 
                data: values, 
                backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#8BC34A", "#9C27B0"] 
            }] 
        },
        options: {
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            let value = tooltipItem.raw;
                            let percentage = ((value / total) * 100).toFixed(1); // 1 decimal place
                            return ` ${percentage}% (${value} views)`; // Shows "23 views (15.2%)"
                        }
                    }
                }
            }
        }
    });
}

function destroyChart(elementId) {
    if (chartInstances[elementId]) {
        chartInstances[elementId].destroy();
        delete chartInstances[elementId];
    }
}

async function loadRawData(period = "today") {
    const match = window.location.pathname.match(/^\/(\d+)\//);
    if (!match) return console.error("‚ùå No valid site ID found.");

    const siteId = match[1];
    console.log(`üì° Fetching raw analytics data for ${siteId}, period: ${period}`);

    await loadExhibitData(siteId); // ‚úÖ Ensure exhibit data is loaded first

    try {
        const response = await fetch(`https://get-curio.us/api/view-analytics/${siteId}/${period}/`);
        const data = await response.json();

        console.log("üìä API Response:", data);

        if (!data || data.error) {
            console.warn(`‚ö†Ô∏è No data available for ${period}`);
            rawData = [];
        } else {
            rawData = data.raw_data || [];
        }

        displayTablePage(1);
    } catch (error) {
        console.error(`‚ùå Fetch Error for ${period}:`, error);
    }
}

function createExhibitLookup(data) {
  console.log("üìÑ Exhibit Lookup Table Created:", exhibitLookup);
    const lookup = {};
    data.exhibits.forEach(exhibit => {
        lookup[exhibit.exhibitID] = {
            exhibitName: exhibit.exhibitName,
            objects: exhibit.objects.reduce((objLookup, obj) => {
                objLookup[obj.objectID] = obj.nickname || obj.commonName || "Unknown";
                return objLookup;
            }, {})
        };
    });
    return lookup;
}

function formatDate(timestamp) {
    return new Date(timestamp).toISOString().split("T")[0]; // Extract YYYY-MM-DD
}

function formatTime(timestamp) {
    return new Date(timestamp).toISOString().split("T")[1].slice(0, 5); // Extract HH:MM
}

function displayTablePage(page) {
    const tableBody = document.querySelector("#rawDataTable tbody");
    tableBody.innerHTML = "";

    if (!rawData.length) {
        tableBody.innerHTML = "<tr><td colspan='9'>No data available</td></tr>";
        return;
    }

    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const paginatedData = rawData.slice(start, end);

    paginatedData.forEach(row => {
        let exhibitName = exhibitLookup[row.eid]?.exhibitName || "";
        let objectName = exhibitLookup[row.eid]?.objects[row.oid] || "Main Page";

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${formatDate(row.timestamp)}</td>
            <td>${formatTime(row.timestamp)}</td>
            <td>${exhibitName}</td>
            <td>${objectName}</td>
            <td>${row.browser || "Unknown"}</td>
            <td>${row.os || "Unknown"}</td>
            <td>${row.device || "Unknown"}</td>
        `;
        tableBody.appendChild(tr);
    });

    document.getElementById("pageInfo").textContent = `Page ${page} of ${Math.ceil(rawData.length / rowsPerPage)}`;
    currentPage = page;
}

document.getElementById("prevPage").addEventListener("click", function () {
    if (currentPage > 1) displayTablePage(currentPage - 1);
});

document.getElementById("nextPage").addEventListener("click", function () {
    if (currentPage < Math.ceil(rawData.length / rowsPerPage)) displayTablePage(currentPage + 1);
});

document.getElementById("downloadCSV").addEventListener("click", function () {
    const csvContent = "data:text/csv;charset=utf-8," + [
        "Date,Time,Page,Exhibit,Object,Browser,OS,Device,Traffic Source",
        ...rawData.map(row =>
            `${formatDate(row.timestamp)},${formatTime(row.timestamp)},${row.path},${row.eid},${row.oid},${row.browser},${row.os},${row.device},${row.traffic_source}`
        )
    ].join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `analytics_${Date.now()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});

document.getElementById("period-select").addEventListener("change", function () {
    updateVisualisations(this.value);
    loadRawData(this.value);
});

window.onload = function () {
    loadAnalytics();
    updateVisualisations("today");
    loadRawData("today");
};

function getObjectName(objectId) {
    for (let exhibit in exhibitLookup) {
        if (exhibitLookup[exhibit].objects && exhibitLookup[exhibit].objects[objectId]) {
            return exhibitLookup[exhibit].objects[objectId]; // ‚úÖ Return the correct object name
        }
    }
    return "Unknown"; // ‚ùå If not found, return "Unknown"
}
      </script>

      </div>
</body>
</html>